<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curriculum Planner</title>
    <!-- Fonts: Fredoka for headings, Nunito for body (High Readability) -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* Base Canvas - BRIGHT & HAPPY */
            --bg-body: #FFFFFF;
            --bg-card: #FFFFFF;
            
            /* Text: Deep Indigo/Blue instead of depressing Gray */
            --text-primary: #1E1B4B; /* Indigo 950 */
            --text-secondary: #4338CA; /* Indigo 700 */
            
            /* Borders: Soft Violet/Indigo tints instead of Gray */
            --border-subtle: #E0E7FF; /* Indigo 100 */
            --border-input: #C7D2FE; /* Indigo 200 - Happy Periwinkle */
            
            /* Vibrant Neuro-Inclusive Palette */
            --accent-pink: #ED64A6;
            --accent-cyan: #0BC5EA;
            --accent-purple: #9F7AEA;
            --accent-yellow: #ECC94B;
            --accent-orange: #ED8936;
            --accent-green: #48BB78;
            --accent-indigo: #667EEA;
            --accent-red: #F56565;
            --accent-teal: #38B2AC;

            /* Subject Mappings (Unit Card Borders) */
            --color-math: var(--accent-pink);
            --color-science: var(--accent-cyan);
            --color-english: var(--accent-purple);
            --color-history: var(--accent-yellow);
            --color-art: var(--accent-orange);
            --color-music: #D53F8C;
            --color-health: var(--accent-green);
            --color-general: var(--accent-indigo);

            /* UI Physics */
            --radius-lg: 16px;
            --radius-md: 12px; /* Slightly rounder for friendliness */
            --radius-sm: 8px;
            --shadow-sm: 0 2px 4px rgba(99, 102, 241, 0.1); /* Indigo shadow tint */
            --shadow-md: 0 4px 6px -1px rgba(99, 102, 241, 0.15), 0 2px 4px -1px rgba(99, 102, 241, 0.1);
            --shadow-float: 0 10px 15px -3px rgba(99, 102, 241, 0.15), 0 4px 6px -2px rgba(99, 102, 241, 0.1);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            /* Happy Confetti-like Grid */
            background-image: radial-gradient(#C7D2FE 1.5px, transparent 1.5px);
            background-size: 24px 24px;
        }

        #app-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding-bottom: 60px;
        }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            padding: 24px 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid var(--border-subtle);
            flex-wrap: wrap;
            gap: 16px;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple), var(--accent-pink), var(--accent-yellow));
        }

        .header-title h1 {
            font-family: 'Fredoka', sans-serif;
            font-size: 2rem;
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .header-title span {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .header-actions { display: flex; gap: 12px; }

        /* --- BUTTONS --- */
        .btn {
            font-family: 'Fredoka', sans-serif;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-input);
            cursor: pointer;
            font-size: 0.95rem;
            background: white;
            color: var(--text-secondary);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            user-select: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: var(--text-primary);
            border-color: var(--accent-indigo);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-indigo), #5A67D8);
            color: white;
            border: 2px solid transparent;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
            color: white;
            border-color: transparent;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 0.8rem;
            background: #EEF2FF; /* Indigo 50 */
            color: var(--text-secondary);
            font-weight: 700;
            border-radius: 20px;
            border: none;
        }
        .btn-sm:hover { background: #E0E7FF; color: var(--text-primary); }

        /* --- CONTROLS AREA --- */
        .controls-wrapper {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            gap: 16px;
            border: 2px solid var(--border-subtle);
        }

        .search-bar-row { display: flex; gap: 12px; flex-wrap: wrap; }

        /* --- VIBRANT INPUTS --- */
        .form-control {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid var(--border-input);
            border-radius: var(--radius-md);
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
            background: #FFFFFF; /* Pure White */
            color: var(--text-primary);
        }

        .form-control:focus {
            border-color: var(--accent-cyan);
            background: #F0F9FF; /* Alice Blue tint on focus */
            box-shadow: 0 0 0 3px rgba(11, 197, 234, 0.2);
        }

        .form-control::placeholder {
            color: #A5B4FC; /* Light Indigo placeholder */
        }

        .filter-pills {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none; 
        }
        .filter-pills::-webkit-scrollbar { display: none; }

        .pill {
            padding: 8px 18px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 700;
            font-family: 'Fredoka', sans-serif;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text-secondary);
            background: #EEF2FF;
            border: 1px solid transparent;
            transition: var(--transition);
        }

        .pill:hover { background: #E0E7FF; transform: translateY(-1px); color: var(--accent-indigo); }
        
        .pill.active {
            background: var(--text-primary);
            color: white;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.25);
        }
        .pill[data-subject="Math"].active { background: var(--color-math); box-shadow: 0 4px 10px rgba(237, 100, 166, 0.4); }
        .pill[data-subject="Science"].active { background: var(--color-science); box-shadow: 0 4px 10px rgba(11, 197, 234, 0.4); }

        /* --- GRID --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            align-items: start;
        }

        .section-header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 24px 0 12px 0;
            font-family: 'Fredoka', sans-serif;
            font-size: 1.25rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        .section-header::after { flex: 1; height: 2px; background: var(--border-subtle); content: ''; border-radius: 2px; }

        /* --- CARD --- */
        .card {
            background: white;
            border: 2px solid var(--border-subtle);
            border-top-width: 6px !important; 
            border-top-style: solid;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-float); border-color: #C7D2FE; }

        .card-header-bar {
            padding: 20px;
            cursor: pointer;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid transparent;
            transition: background 0.2s;
        }
        
        .card.expanded .card-header-bar { border-bottom: 1px solid var(--border-subtle); background: #EEF2FF; }

        .card h3 {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.4rem;
            margin: 6px 0 4px 0;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .card-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 600;
            display: block;
            margin-bottom: 2px;
        }

        .tag {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            padding: 4px 8px;
            border-radius: 6px;
            color: white;
            letter-spacing: 0.5px;
            display: inline-block;
            margin-bottom: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-body-content { display: none; padding: 0; background: #FFF; }
        .card.expanded .card-body-content { display: block; animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        .info-block {
            background: #FFFBEB; /* Warm Amber Tint */
            padding: 16px 20px;
            font-size: 0.95rem;
            color: var(--text-primary);
            line-height: 1.6;
            border-bottom: 1px solid var(--border-subtle);
            font-style: italic;
        }

        /* Vocab Styling */
        .vocab-box { padding: 16px 20px; background: white; }
        .vocab-header {
            font-size: 0.75rem; font-weight: 800; color: var(--text-secondary);
            text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 0.5px;
        }
        .vocab-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .vocab-chip {
            background: #F0F9FF;
            border: 1px solid #BAE6FD;
            color: #0284C7;
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 700;
            display: flex; gap: 6px; align-items: center;
            cursor: default;
        }
        .vocab-link-icon { font-size: 0.7em; opacity: 0.6; }

        /* --- LESSON LIST --- */
        .lesson-list-controls {
            padding: 12px 20px;
            background: #EEF2FF; /* Indigo Tint */
            border-bottom: 1px solid var(--border-subtle);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .lesson-list { 
            display: block; 
            padding-bottom: 10px; 
        }
        .lesson-list.collapsed { display: none; }

        /* STRAND HEADERS */
        .strand-group { margin-top: 12px; }
        .strand-header {
            padding: 8px 20px;
            background: #F5F3FF; /* Violet Tint */
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            color: #7C3AED;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex; align-items: center;
        }

        .lesson-row {
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid var(--border-subtle);
            padding: 14px 20px;
            transition: background 0.1s;
            border-left: 6px solid #C4B5FD; /* Fallback Violet */
            background: white;
        }
        .lesson-row:last-child { border-bottom: none; }

        .lesson-header { display: flex; align-items: flex-start; gap: 16px; justify-content: space-between; }

        /* OFFICIAL STATUS BADGE */
        .status-badge {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 12px;
            letter-spacing: 0.5px;
            display: inline-block;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            user-select: none;
        }

        .status-badge.taught { background: #DCFCE7; color: #16A34A; border: 1px solid #86EFAC; }
        .status-badge.planned { background: #F3E8FF; color: #7C3AED; border: 1px solid #D8B4FE; }

        .lesson-date {
            font-size: 0.85rem; font-weight: 800; color: #818CF8;
            min-width: 50px; margin-top: 5px; font-family: monospace;
        }

        .lesson-info-col { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        
        .lesson-name {
            font-size: 1.05rem; font-weight: 700; color: var(--text-primary);
            line-height: 1.4;
        }

        /* Notes and Details */
        .lesson-details-block {
            display: none; 
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-subtle);
        }
        
        .lesson-list.details-visible .lesson-details-block { display: block; }

        .notes-text {
            font-size: 0.95rem; color: var(--text-secondary);
            font-style: italic; line-height: 1.5;
            background: #F8FAFC; padding: 8px; border-radius: 6px;
            white-space: pre-line;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); /* Bright Overlay */
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal-card {
            background: white;
            width: 95%; max-width: 900px; height: 90vh;
            border-radius: var(--radius-lg);
            display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(99, 102, 241, 0.25);
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid var(--border-subtle);
        }

        .modal-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 2px solid var(--border-subtle);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { margin: 0; font-family: 'Fredoka', sans-serif; color: var(--text-primary); font-size: 1.6rem; }
        
        .close-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: #FECACA; color: #DC2626;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-weight: 800; transition: var(--transition);
        }
        .close-btn:hover { background: #DC2626; color: white; }

        /* Modal Tabs */
        .modal-tabs {
            display: flex; background: #EEF2FF; padding: 15px 30px 0 30px;
            gap: 8px; border-bottom: 2px solid var(--border-subtle);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-family: 'Fredoka', sans-serif;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s;
            font-size: 1rem;
            position: relative;
        }
        
        .tab-btn:hover { background: #C7D2FE; color: var(--text-primary); }
        
        .tab-btn.active {
            background: white;
            color: var(--accent-indigo);
            font-weight: 600;
            box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05);
        }
        .tab-btn.active::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 3px; background: var(--accent-indigo);
            border-radius: 3px 3px 0 0;
        }

        .modal-body { flex: 1; overflow-y: auto; background: white; }
        .tab-content { display: none; padding: 30px; animation: fadeIn 0.3s; max-width: 800px; margin: 0 auto; }
        .tab-content.active { display: block; }

        /* Forms */
        .form-row { display: flex; gap: 24px; margin-bottom: 24px; flex-wrap: wrap; }
        .form-col { flex: 1; min-width: 250px; }
        
        label {
            display: block; font-size: 0.8rem; font-weight: 800;
            text-transform: uppercase; color: var(--text-secondary);
            margin-bottom: 8px; letter-spacing: 1px;
        }
        
        /* THE INPUT BOXES - COLORFUL & BRIGHT */
        input, select, textarea {
            width: 100%; padding: 14px;
            border: 2px solid var(--border-input);
            font-family: 'Nunito', sans-serif; font-size: 1rem;
            border-radius: var(--radius-md); transition: var(--transition);
            background: #FFFFFF; /* Pure White */
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-indigo);
            background: #F5F3FF; /* Very faint violet background */
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15);
        }

        /* Complex Input Rows */
        .complex-row {
            display: grid; gap: 12px; align-items: start;
            background: white; 
            border: 2px solid var(--border-subtle);
            padding: 16px; border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            position: relative;
        }
        .complex-row:hover { border-color: #A5B4FC; box-shadow: var(--shadow-md); }
        .complex-row.highlight-row {
            border: 2px solid var(--accent-orange);
            background: #FFF7ED;
            animation: pulse 1.5s infinite;
        }

        /** Updated Lesson Log Grid for Categories */
        .lesson-grid-inp { grid-template-columns: 150px 170px 2.5fr 36px; }
        
        /* UPDATED VOCAB GRID (Simpler now) */
        .vocab-grid-inp { 
            grid-template-columns: 1fr 1fr 36px;
        }
        
        /* Activity Grid: Date, Type, Name (Link moved down), Delete */
        /* Adjusted grid columns to account for removing Link from top row */
        .activity-grid-inp { grid-template-columns: 150px 170px 2.5fr 36px; }

        @media (max-width: 900px) {
          /* Keep Lesson + Vocab stacked */
          .lesson-grid, .vocab-grid-inp {
            grid-template-columns: 1fr;
            gap: 8px;
          }

          /* Updated activity grid mobile view */
          .activity-grid-inp, .lesson-grid-inp {
            grid-template-columns: 150px 140px 2fr 36px; /* Adjusted */
            gap: 10px;
          }

          /* Keep notes full width */
          .complex-row textarea {
            grid-column: 1 / -1 !important;
          }
        }

        .modal-footer {
            padding: 20px 30px; border-top: 2px solid var(--border-subtle);
            background: #FAFAFA; display: flex; justify-content: flex-end; gap: 12px;
        }

        .helper-text {
            font-size: 0.9rem; color: var(--text-secondary);
            margin-bottom: 20px; padding: 10px 15px;
            background: #EFF6FF; border-radius: var(--radius-sm);
            border-left: 4px solid var(--accent-cyan);
            display: flex; align-items: center; gap: 8px;
        }
        .helper-text::before { content: '‚ÑπÔ∏è'; }

        /* Overview Dashboard inside Modal */
        .dash-section {
            background: white; border: 2px solid var(--border-subtle);
            border-radius: var(--radius-md); padding: 24px;
            margin-bottom: 24px; position: relative;
            box-shadow: var(--shadow-sm);
        }
        .dash-section h3 {
            margin: 0 0 20px 0; font-family: 'Fredoka', sans-serif;
            color: var(--text-primary); font-size: 1.3rem;
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 12px; border-bottom: 2px solid #E0E7FF;
        }

        .dash-edit-btn {
            background: #E0E7FF; border: none; padding: 6px 14px;
            border-radius: 20px; font-size: 0.75rem; cursor: pointer;
            color: var(--text-secondary); font-weight: 700; text-transform: uppercase;
            transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .dash-edit-btn:hover { background: var(--accent-indigo); color: white; }

        .dash-info-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 20px; }
        
        .dash-label { font-size: 0.7rem; font-weight: 800; color: #A5B4FC; text-transform: uppercase; display: block; margin-bottom: 6px; letter-spacing: 0.5px; }
        .dash-val { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; }

        .dash-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px dashed #E0E7FF;
        }
        .dash-list-item:last-child { border-bottom: none; }
        
        .dash-list-main { font-weight: 700; color: var(--text-primary); font-size: 1rem; }
        .dash-list-sub { font-size: 0.85rem; color: #6366F1; margin-top: 4px; }
        
        .item-edit-icon {
            color: #C7D2FE; cursor: pointer; padding: 8px;
            border-radius: 6px; transition: var(--transition);
        }
        .item-edit-icon:hover { color: var(--accent-orange); background: #FFF7ED; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(237, 137, 54, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(237, 137, 54, 0); } 100% { box-shadow: 0 0 0 0 rgba(237, 137, 54, 0); } }

        /* Loading Screen */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFFFFF; z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Fredoka', sans-serif; font-size: 2rem;
            color: var(--accent-indigo);
            transition: opacity 0.5s;
        }
        .hidden { opacity: 0; pointer-events: none; }

        .status-right {
          grid-column: 1 / -1;        /* Activity Log: Planned/completed: keeps it under notes */
          display: flex;
          justify-content: flex-end;  /* pushes dropdown right */
          margin-top: 6px;
        }

        /* Add activity and secondary buttons */

        .btn-outline {
          border: 2px solid var(--accent-pink);
          background: linear-gradient(
            135deg,
            rgba(166, 255, 246, 0.35),
            rgba(255, 166, 221, 0.25)
          );
          color: #1E1B4B;
          
        }
        .btn-outline:hover{
          border-color: var(--accent-pink);
          box-shadow: 0 10px 22px rgba(237, 100, 166, 0.22);
          transform: translateY(-1px);
        }

        /* Force overview titles to one line */
        .dash-val {
          white-space: nowrap;  /* forces overview title into one line */
          overflow: hidden;
          text-overflow: ellipsis;
        }
        /* Reusable delete icon (works even when grid collapses) */
        .row-delete{
          position: absolute;
          top: 12px;
          right: 12px;
          width: 28px;
          height: 28px;
          display: flex; /* Changed to flex for precise centering */
          justify-content: center;
          align-items: center;
          padding: 0; /* Crucial: removes default button padding */
          margin: 0;
          cursor: pointer;
          border-radius: 50%; /* Circular like the modal close button */
          font-weight: 800;
          font-size: 12px;      
          color: #DC2626;
          background: #FECACA;
          border: none;
          line-height: 1; /* Ensures vertical centering */
          user-select: none;
          transition: var(--transition);
        }

        .row-delete:hover{
          background: #DC2626;
          color: white;
          transform: scale(1.1);
        }
        .vocab-grid-inp {
          position: relative;     /* REQUIRED for absolute child positioning */
          padding-right: 54px;    /* space so inputs don‚Äôt sit under the X */
        }

        .lesson-grid-inp,
        .activity-grid-inp{
          position: relative;     /* required for absolute X */
          padding-right: 54px;    /* space so inputs don‚Äôt sit under the X */
        }

        /* Optional: if you switch to <button>, remove default button styling */
        button.row-delete{
          appearance: none;
          -webkit-appearance: none;
          border: none;
        }

    </style>
</head>
<body>

<div id="loading-screen">
    <div style="text-align:center;">
        <div>Fetching Data</div>
        <div style="font-size:1rem; color:#A5B4FC; margin-top:10px;">One second...</div>
    </div>
</div>

<div id="app-container">
    <header>
        <div class="header-title">
            <h1>Curriculum Planner</h1>
            <span>Homeschool Log</span>
        </div>
        <div class="header-actions">
            <div class="btn" onclick="window.downloadPDF()">
                <span>üìÑ</span> Export Log (PDF)
            </div>
            <div class="btn btn-primary" onclick="window.openUnit(null)">
                <span>+</span> New Unit
            </div>
        </div>
    </header>

    <div class="controls-wrapper">
        <div class="search-bar-row">
            <input type="text" id="filter-search" class="form-control" placeholder="Search curriculum..." oninput="window.applyFilters()">
            <select id="filter-month" class="form-control" onchange="window.applyFilters()">
                <option value="All">All Dates</option>
            </select>
            <select id="filter-status" class="form-control" onchange="window.applyFilters()">
                <option value="All">All Plans</option>
                <option value="Progress">In Progress</option>
                <option value="Ready">Ready</option>
                <option value="Done">Logged/Done</option>
            </select>
        </div>
        <div class="filter-pills">
            <div class="pill active" data-subject="All" onclick="window.setSubjectFilter('All', this)">All Subjects</div>
            <div class="pill" data-subject="Math" onclick="window.setSubjectFilter('Math', this)">Math</div>
            <div class="pill" data-subject="Science" onclick="window.setSubjectFilter('Science', this)">Science</div>
            <div class="pill" data-subject="English" onclick="window.setSubjectFilter('English', this)">English</div>
            <div class="pill" data-subject="History" onclick="window.setSubjectFilter('History', this)">History</div>
            <div class="pill" data-subject="Specials" onclick="window.setSubjectFilter('Specials', this)">Art/Music/PE</div>
            <div class="pill" data-subject="General" onclick="window.setSubjectFilter('General', this)">General</div>
        </div>
    </div>

    <div id="standard-view">
        <div class="section-header" id="main-header">Curriculum Log</div>
        <div class="grid-container" id="grid-content"></div>
    </div>
</div>

<!-- MODAL -->
<div id="plan-modal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <h2>Curriculum Unit Editor</h2>
            <div class="close-btn" onclick="window.closeModal()">‚úï</div>
        </div>
        
        <div class="modal-tabs">
            <div class="tab-btn active" onclick="window.switchTab('overview')">Overview</div>
            <div class="tab-btn" onclick="window.switchTab('details')">Details</div>
            <div class="tab-btn" onclick="window.switchTab('lessons')">Lesson Log</div>
            <div class="tab-btn" onclick="window.switchTab('activity')">Activity Log</div>
            <div class="tab-btn" onclick="window.switchTab('vocab')">Vocab</div>
        </div>

        <form onsubmit="window.saveUnit(event)" class="modal-body">
            <input type="hidden" id="inp-id">

            <!-- TAB 0: DASHBOARD / OVERVIEW -->
            <div id="tab-overview" class="tab-content active" style="background:#FAFAFA; height:100%;">
                <div id="overview-content"></div>
                <div class="btn btn-primary" onclick="window.closeModal()" style="width:100%; text-align:center; justify-content:center; margin-top:20px;">Close Overview</div>
            </div>

            <!-- TAB 1: DETAILS -->
            <div id="tab-details" class="tab-content">
                <div class="helper-text">Set the high-level goals for this unit.</div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Subject</label>
                        <select id="inp-subject">
                            <option value="Math">Math</option>
                            <option value="Science">Science</option>
                            <option value="English">English</option>
                            <option value="History">History</option>
                            <option value="Art">Art</option>
                            <option value="Music">Music</option>
                            <option value="Health/PE">Health/PE</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Plan Status</label>
                        <select id="inp-status">
                            <option value="Idea">Idea Phase</option>
                            <option value="Ready">Ready to Teach</option>
                            <option value="Progress">In Progress</option>
                            <option value="Done">Completed Log</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Unit Title</label>
                        <input type="text" id="inp-unit" required placeholder="e.g., Ancient Egypt">
                    </div>
                    <div class="form-col">
                        <label>Sub-Topic</label>
                        <input type="text" id="inp-topic" placeholder="e.g., Pyramids">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Date Range (Start)</label>
                        <input type="date" id="inp-start">
                    </div>
                    <div class="form-col">
                        <label>Date Range (End)</label>
                        <input type="date" id="inp-end">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Unit Strategy</label>
                        <textarea id="inp-strategy" rows="3" placeholder="Brief strategy or goal for Gabriel..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn" onclick="window.switchTab('overview')">Back</div>
                    <div class="btn btn-primary" onclick="window.saveUnit(event)">üíæ SAVE DETAILS</div>
                </div>
            </div>

            <!-- TAB 2: LESSONS -->
            <div id="tab-lessons" class="tab-content">
                <div class="helper-text">Add lessons here. Use dropdown to plan or complete.</div>
                <div id="lessons-container"></div>
                <div class="btn" onclick="window.addLessonRow()" style="margin-top:10px; width:fit-content">+ Add Lesson Entry</div>
                <div class="modal-footer">
                    <div class="btn" onclick="window.switchTab('overview')">Back</div>
                    <div class="btn btn-primary" onclick="window.saveUnit(event)">üíæ SAVE LOG</div>
                </div>
            </div>

             <!-- TAB 3: ACTIVITIES -->
             <div id="tab-activity" class="tab-content">
                <div class="helper-text">Log tasks and link them to a lesson.</div>
                <div id="activity-container"></div>
                <div class="btn" onclick="window.addActivityRow()" style="margin-top:10px; width:fit-content">+ Add Activity</div>
                <div class="modal-footer">
                    <div class="btn" onclick="window.switchTab('overview')">Back</div>
                    <div class="btn btn-primary" onclick="window.saveUnit(event)">üíæ SAVE ACTIVITIES</div>
                </div>
            </div>

            <!--VOCABULARY -->
            <div id="tab-vocab" class="tab-content">
                <div class="helper-text">Plan key vocabulary (Word, Link).</div>
                <div id="vocab-container"></div>
                <div class="btn" onclick="window.addVocabRow()" style="margin-top:10px; width:fit-content">+ Add Vocabulary Word</div>
                <div class="modal-footer">
                    <div class="btn" onclick="window.switchTab('overview')">Back</div>
                    <div class="btn btn-primary" onclick="window.saveUnit(event)">üíæ SAVE VOCAB</div>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBTeBLQw1q5BYVfN_KWSsxD17I_UPNvpu4",
        authDomain: "curriculum-planner-73778.firebaseapp.com",
        projectId: "curriculum-planner-73778",
        storageBucket: "curriculum-planner-73778.firebasestorage.app",
        messagingSenderId: "938927665266",
        appId: "1:938927665266:web:ef26b9ee178770a95bd2eb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const COLLECTION = "curriculum_plans"; 

    // Neuro-inclusive Rotating Palette
    const rotatingPalette = [
        '#ED64A6', // pink
        '#0BC5EA', // cyan
        '#9F7AEA', // purple
        '#ECC94B', // yellow
        '#ED8936', // orange
        '#48BB78', // green
        '#667EEA', // indigo
        '#38B2AC'  // teal
    ];

    let plans = [];
    let activeFilters = { subject: 'All', status: 'All', month: 'All', search: '' };
    const subjectColors = {
        'Math': 'var(--color-math)', 'Science': 'var(--color-science)', 'English': 'var(--color-english)',
        'History': 'var(--color-history)', 'Art': 'var(--color-art)', 'Music': 'var(--color-music)',
        'Health/PE': 'var(--color-health)', 'General': 'var(--color-general)'
    };

    onAuthStateChanged(auth, (user) => { if (user) loadData(); else signInAnonymously(auth); });

    function loadData() {
        onSnapshot(collection(db, COLLECTION), (snap) => {
            plans = [];
            snap.forEach(doc => { plans.push({ id: doc.id, ...doc.data() }); });
            document.getElementById('loading-screen').classList.add('hidden');
            updateDynamicFilters();
            applyFilters();
        });
    }

    // --- FILTER LOGIC ---
    window.setSubjectFilter = function(subject, el) {
        activeFilters.subject = subject;
        document.querySelectorAll('.pill').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        applyFilters();
    };

    function updateDynamicFilters() {
        const months = new Set();
        plans.forEach(p => { if(p.plannedStart) months.add(p.plannedStart.substring(0, 7)); }); 
        const select = document.getElementById('filter-month');
        select.innerHTML = '<option value="All">All Dates</option>';
        Array.from(months).sort().reverse().forEach(m => {
            const opt = document.createElement('option'); opt.value = m; opt.innerText = m; select.appendChild(opt);
        });
    }

    window.applyFilters = function() {
        activeFilters.search = document.getElementById('filter-search').value.toLowerCase();
        activeFilters.status = document.getElementById('filter-status').value;
        activeFilters.month = document.getElementById('filter-month').value;

        const filtered = plans.filter(p => {
            if (activeFilters.subject === 'Specials') {
                if (!['Art', 'Music', 'Health/PE'].includes(p.subject)) return false;
            } else if (activeFilters.subject !== 'All' && p.subject !== activeFilters.subject) return false;
            
            if (activeFilters.status !== 'All' && p.status !== activeFilters.status) return false;
            if (activeFilters.month !== 'All' && (!p.plannedStart || !p.plannedStart.startsWith(activeFilters.month))) return false;
            if (activeFilters.search && !`${p.unit} ${p.topic || ''}`.toLowerCase().includes(activeFilters.search)) return false;
            return true;
        });

        renderGrid(filtered);
    };

    // --- RENDER GRID (Main Dashboard) ---
    window.toggleLessonList = function(listId, btnEl) {
        if(event) event.stopPropagation();
        const list = document.getElementById(listId);
        if(!list) return;
        
        list.classList.toggle('collapsed');
        
        // NEW: Toggle activity list too
        const docId = listId.replace('list-', '');
        const actList = document.getElementById(`activity-list-${docId}`);
        if(actList) actList.classList.toggle('collapsed');

        btnEl.innerText = list.classList.contains('collapsed') ? 'Show Logs' : 'Hide Logs';
    };

    window.toggleAllDetails = function(listId, btnEl) {
        if(event) event.stopPropagation();
        const list = document.getElementById(listId);
        if(!list) return;
        list.classList.toggle('details-visible');
        btnEl.innerText = list.classList.contains('details-visible') ? 'Hide Full Details' : 'Show Full Details';
    };

    function renderGrid(data) {
        const container = document.getElementById('grid-content');
        container.innerHTML = '';
        const statusScore = { 'Progress': 1, 'Ready': 2, 'Idea': 3, 'Done': 4 };
        data.sort((a,b) => (statusScore[a.status] || 9) - (statusScore[b.status] || 9));

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card expanded'; 
            card.style.borderTopColor = subjectColors[item.subject];
            
            // Vocab Preview (With Tooltip logic for definition)
            let vocabHtml = '';
            if(item.vocabulary && item.vocabulary.length > 0) {
                vocabHtml = `<div class="vocab-box"><span class="vocab-header">Vocabulary Focus</span><div class="vocab-grid">`;
                item.vocabulary.forEach(v => {
                    const linked = v.linkedLesson ? `<span class="vocab-link-icon" title="Linked to: ${v.linkedLesson}">üîó</span>` : '';
                    // Simple tooltip since we removed complex definitions
                    const tooltipText = v.word; // removed root from tooltip
                    vocabHtml += `<div class="vocab-chip" title="${tooltipText}">${v.word} ${linked}</div>`;
                });
                vocabHtml += `</div></div>`;
            }

            // *** DATA RECOVERY LOGIC ***
            const legacyFlex = item.lessons ? item.lessons.filter(l => l.isFlex === true) : [];
            const realLessons = item.lessons ? item.lessons.filter(l => !l.isFlex) : [];
            const legacyFlexAsActivities = legacyFlex.map(l => ({
                name: l.name,
                date: l.date,
                details: l.details,
                type: 'General (Legacy)',
                linkedLesson: '',
                status: 'Completed'
            }));
            const allActivities = [...(item.activities || []), ...legacyFlexAsActivities];

            // FULL Detailed Lesson List
            let lessonHtml = '';
            const listId = `list-${item.id}`;
            
            if(realLessons.length > 0) {
                lessonHtml += `
                    <div class="lesson-list-controls">
                        <div class="btn btn-sm" onclick="window.toggleLessonList('${listId}', this)">Hide Lesson Log</div>
                        <div class="btn btn-sm" style="background:transparent; border:1px solid #E0E7FF;" onclick="window.toggleAllDetails('${listId}', this)">Show Full Details</div>
                    </div>
                    <div id="${listId}" class="lesson-list">
                `;
                
                const categories = {};
                const order = ['Literary Analysis', 'Vocab. Application ', 'Reading', 'Writing', 'Sentence Structure', 'Quiz', 'General'];
                
                realLessons.forEach((l, idx) => {
                    const cat = l.category || 'General';
                    if(!categories[cat]) categories[cat] = [];
                    categories[cat].push({ ...l, originalIdx: idx }); 
                });

                const allCats = [...new Set([...order, ...Object.keys(categories)])]; 
                let globalCounter = 0; 

                allCats.forEach(catName => {
                    if(categories[catName]) {
                        lessonHtml += `<div class="strand-group"><div class="strand-header">${catName}</div>`;
                        
                        categories[catName].forEach((l) => {
                            const dateDisplay = formatDate(l.date);
                            const isCompleted = (l.status === 'Completed' || l.status === 'Taught');
                            const statusLabel = isCompleted ? 'COMPLETED' : 'PLANNED';
                            const statusClass = isCompleted ? 'taught' : 'planned';
                            
                            const borderColor = rotatingPalette[globalCounter % rotatingPalette.length];
                            globalCounter++;

                            lessonHtml += `
                                <div class="lesson-row" style="border-left: 6px solid ${borderColor} !important;">
                                    <div class="lesson-header">
                                        <div style="display:flex; gap:16px;">
                                            <div class="lesson-date">${dateDisplay}</div>
                                            <div class="lesson-info-col">
                                                <div class="lesson-name">${l.name}</div>
                                            </div>
                                        </div>
                                        <div class="status-badge ${statusClass}" title="Toggle Status" onclick="event.stopPropagation(); window.toggleLessonStatus('${item.id}', '${l.name}')">${statusLabel}</div>
                                    </div>
                                    <div class="lesson-details-block">
                                        ${l.details ? `<div class="notes-text">${l.details}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        lessonHtml += `</div>`;
                    }
                });
                lessonHtml += `</div>`;
            } else {
                lessonHtml = `<div style="padding:20px; color:#A5B4FC; font-style:italic;">No lessons logged.</div>`;
            }

            // Render Activities Section
            let activityHtml = '';
            if(allActivities.length > 0) {
                // WRAPPER ADDED
                activityHtml += `<div id="activity-list-${item.id}" class="lesson-list">`;
                
                // Changed Activity Log header color to a clean vibrant gradient
                activityHtml += `<div class="strand-group" style="border-top:2px solid #E0E7FF; margin-top:20px;"><div class="strand-header" style="background:#FFF7ED; color:#EA580C;">Activity Log</div>`;
                let actGlobalCounter = 0; // Added counter for activity colors
                
                allActivities.forEach(a => {
                      const dateDisplay = formatDate(a.date);
                      const isCompleted = (a.status === 'Completed');
                      const statusLabel = isCompleted ? 'COMPLETED' : 'PLANNED';
                      const statusClass = isCompleted ? 'taught' : 'planned';

                      // Apply Rotating Palette Logic here
                      const actBorderColor = rotatingPalette[actGlobalCounter % rotatingPalette.length];
                      actGlobalCounter++;

                      activityHtml += `
                        <div class="lesson-row" style="border-left: 6px solid ${actBorderColor} !important;">
                            <div class="lesson-header">
                                <div style="display:flex; gap:16px;">
                                    <div class="lesson-date">${dateDisplay}</div>
                                    <div class="lesson-info-col">
                                        <div class="lesson-name">${a.name}</div>
                                        <div style="font-size:0.85rem; color:#4338CA;">${a.type} ${a.linkedLesson ? `‚Ä¢ üîó ${a.linkedLesson}` : ''}</div>
                                    </div>
                                </div>
                                <div class="status-badge ${statusClass}" title="Toggle Status" onclick="event.stopPropagation(); window.toggleActivityStatus('${item.id}', '${a.name}')">${statusLabel}</div>
                            </div>
                            ${a.details ? `<div style="margin-top:8px; font-size:0.9rem; font-style:italic; color:#4338CA;">${a.details}</div>` : ''}
                        </div>
                      `;
                });
                activityHtml += `</div>`; // Close strand-group
                activityHtml += `</div>`; // Close wrapper
            }

            card.innerHTML = `
                <div class="card-header-bar" onclick="this.parentElement.classList.toggle('expanded')">
                    <div>
                        <span class="tag" style="background:${subjectColors[item.subject]}">${item.subject}</span>
                        <h3>${item.unit}</h3>
                        <div class="card-subtitle">${item.topic || ''}</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="btn" onclick="event.stopPropagation(); window.openUnit('${item.id}')" style="font-size:0.75rem; padding:4px 8px;">‚úé EDIT</div>
                    </div>
                </div>
                <div class="card-body-content">
                    ${item.strategy ? `<div class="info-block">${item.strategy}</div>` : ''}
                    ${vocabHtml}
                    ${lessonHtml}
                    ${activityHtml}
                </div>
            `;
            container.appendChild(card);
        });
    }

    // --- MODAL & OVERVIEW LOGIC ---

    window.openUnit = function(id = null) {
        if(event) event.stopPropagation(); 
        
        document.getElementById('plan-modal').classList.add('active');
        document.querySelector('form').reset();
        document.getElementById('inp-id').value = id || '';
        document.getElementById('lessons-container').innerHTML = '';
        document.getElementById('activity-container').innerHTML = '';
        document.getElementById('vocab-container').innerHTML = '';
        
        if(id) {
            const item = plans.find(p => p.id === id);
            if(item) {
                populateInputs(item);
                renderOverview(item);
            }
        } else {
            window.addLessonRow();
            window.addActivityRow();
            window.addVocabRow();
            renderOverview(null); 
        }
        window.switchTab('overview');
    };

    function renderOverview(item) {
        const div = document.getElementById('overview-content');
        if(!item) {
            div.innerHTML = `
                <div class="dash-section" style="text-align:center; padding:60px;">
                    <h3>New Unit</h3>
                    <p style="color:#6366F1; margin-bottom:20px;">Get started by adding details.</p>
                    <div class="btn btn-primary" onclick="window.switchTab('details')" style="margin:0 auto; width:fit-content;">Start Editing</div>
                </div>
            `;
            return;
        }

        const legacyFlex = item.lessons ? item.lessons.filter(l => l.isFlex === true) : [];
        const realLessons = item.lessons ? item.lessons.filter(l => !l.isFlex) : [];
        const legacyFlexAsActivities = legacyFlex.map(l => ({
            name: l.name,
            date: l.date,
            type: 'General (Legacy)',
            linkedLesson: '',
            status: 'Completed'
        }));
        const allActivities = [...(item.activities || []), ...legacyFlexAsActivities];

        // Full Lists for Overview
        let lessonRows = '';
        if(realLessons.length > 0) {
            realLessons.forEach(l => {
                  const statusIcon = (l.status==='Completed'||l.status==='Taught') ? '‚úÖ' : 'üóìÔ∏è';
                  lessonRows += `
                    <div class="dash-list-item">
                        <div>
                            <span style="font-size:0.75rem; font-weight:800; color:#A5B4FC; margin-right:8px;">${formatDate(l.date)}</span>
                            <span class="dash-list-main">${l.name}</span>
                            <span style="font-size:0.75rem; background:#EEF2FF; padding:2px 6px; border-radius:4px; margin-left:6px;">${l.category||'General'}</span>
                        </div>
                        <div style="font-size:0.8rem;">${statusIcon}</div>
                    </div>`;
            });
        } else { lessonRows = '<div style="color:#A5B4FC; font-style:italic;">No lessons found.</div>'; }

        let activityRows = '';
        if(allActivities.length > 0) {
            allActivities.forEach(a => {
                const statusIcon = (a.status==='Completed') ? '‚úÖ' : 'üóìÔ∏è';
                activityRows += `
                    <div class="dash-list-item">
                        <div>
                            <span style="font-size:0.75rem; font-weight:800; color:#EA580C; margin-right:8px;">${formatDate(a.date)}</span>
                            <span class="dash-list-main">${a.name}</span>
                            <div style="font-size:0.8rem; color:#6366F1;">Type: ${a.type} ${a.linkedLesson ? `‚Ä¢ Link: ${a.linkedLesson}` : ''}</div>
                        </div>
                        <div style="font-size:0.8rem;">${statusIcon}</div>
                    </div>`;
            });
        } else { activityRows = '<div style="color:#A5B4FC; font-style:italic;">No activities logged.</div>'; }


        div.innerHTML = `
            <div class="dash-section">
                <h3>Unit Details <div class="dash-edit-btn" onclick="window.switchTab('details')">‚úé Edit</div></h3>
                <div class="dash-info-grid">
                    <div><span class="dash-label">Title</span><div class="dash-val">${item.unit}</div></div>
                    <div><span class="dash-label">Subject</span><div class="dash-val" style="color:${subjectColors[item.subject]}">${item.subject}</div></div>
                    <div><span class="dash-label">Start</span><div class="dash-val">${formatDate(item.plannedStart)}</div></div>
                    <div><span class="dash-label">Status</span><div class="dash-val">${item.status}</div></div>
                </div>
                <div style="margin-top:20px; text-align:right;">
                    <div class="btn" style="font-size:0.8rem; background:#FEF2F2; color:#DC2626; border:none; display:inline-flex;" onclick="window.deleteUnit('${item.id}')">Delete Unit</div>
                </div>
            </div>
            
            <div class="dash-section">
                <h3>Lesson Log <div class="dash-edit-btn" onclick="window.switchTab('lessons')">‚úé Edit</div></h3>
                <div style="max-height:300px; overflow-y:auto;">${lessonRows}</div>
            </div>

            <div class="dash-section">
                <h3>Activity Log <div class="dash-edit-btn" onclick="window.switchTab('activity')">‚úé Edit</div></h3>
                <div style="max-height:300px; overflow-y:auto;">${activityRows}</div>
            </div>
        `;
    }

    function populateInputs(item) {
        document.getElementById('inp-subject').value = item.subject;
        document.getElementById('inp-status').value = item.status;
        document.getElementById('inp-unit').value = item.unit;
        document.getElementById('inp-topic').value = item.topic || '';
        document.getElementById('inp-start').value = item.plannedStart || '';
        document.getElementById('inp-end').value = item.plannedEnd || '';
        document.getElementById('inp-strategy').value = item.strategy || '';
        
        if(item.lessons) item.lessons.filter(l => !l.isFlex).forEach(l => window.addLessonRow(l));
        
        const legacyFlex = item.lessons ? item.lessons.filter(l => l.isFlex === true) : [];
        const legacyFlexAsActivities = legacyFlex.map(l => ({
            name: l.name,
            date: l.date,
            details: l.details,
            type: 'General', 
            linkedLesson: '',
            status: 'Completed'
        }));
        const allActivities = [...(item.activities || []), ...legacyFlexAsActivities];
        allActivities.forEach(a => window.addActivityRow(a));

        if(item.vocabulary) item.vocabulary.forEach(v => window.addVocabRow(v));
    }

    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="window.switchTab('${tabName}')"]`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        if(tabName === 'vocab' || tabName === 'activity') window.updateLessonLinkOptions();
    };
    window.closeModal = function() { document.getElementById('plan-modal').classList.remove('active'); };

    window.addLessonRow = function(l = {}) {
        const div = document.createElement('div');
        div.className = 'complex-row lesson-grid-inp';
        div.innerHTML = `
            <input type="date" class="inp-l-date" value="${l.date || ''}">
            <select class="inp-l-cat">
                <option value="" ${!l.category ? 'selected' : ''}></option>
                <option value="General" ${l.category==='General'?'selected':''}>General</option>
                <option value="Literary Analysis" ${l.category==='Literary Analysis'?'selected':''}>Literary Analysis</option>
                <option value="Reading" ${l.category==='Reading'?'selected':''}>Reading</option>
                <option value="Vocab. Application" ${l.category==='Vocab. Application'?'selected':''}>Vocab. Application</option>
                <option value="Writing" ${l.category==='Writing'?'selected':''}>Writing</option>
                <option value="Sentence Structure" ${l.category==='Sentence Structure'?'selected':''}>Sentence Structure</option>
                <option value="Quiz" ${l.category==='Quiz'?'selected':''}>Quiz</option>
            </select>
            <input type="text" class="inp-l-name" placeholder="Focus / Topic (e.g. Setting)" value="${l.name || ''}">
            <div class="row-delete" onclick="this.parentElement.remove()">‚úï</div>
            <textarea class="inp-l-notes" placeholder="Details (e.g. Hatchet Ch 3-5, analysis...)" style="grid-column: 1 / -1; height:120px; min-height: 120px ;resize: vertical;">${l.details || ''}</textarea>
            
            <div class="status-right" style="grid-column: 1 / -1; display:flex; gap:10px; align-items:center;">
                <select class="inp-l-status" style="max-width: 220px;">
                    <option value="Planned" ${l.status==='Planned'?'selected':''}>Planned</option>
                    <option value="Completed" ${l.status==='Completed'||l.status==='Taught'?'selected':''}>Completed</option>
                </select>
            </div>
        `;
        document.getElementById('lessons-container').appendChild(div);
    };

  window.addActivityRow = function(a = {}) {
  const div = document.createElement('div');
  div.className = 'complex-row activity-grid-inp';

  let lessonOpts = '<option value="">Lesson</option>';
  if (a.linkedLesson) lessonOpts += `<option value="${a.linkedLesson}" selected>${a.linkedLesson}</option>`;

  div.innerHTML = `
    <input type="date" class="inp-a-date" value="${a.date || ''}"> 

    <select class="inp-a-type">
      <option value="" ${!a.type ? 'selected' : ''}></option>
      <option value="General" ${a.type==='General'?'selected':''}>General</option>
      <option value="Literary Analysis" ${a.type==='Literary Analysis'?'selected':''}>Literary Analysis</option>
      <option value="Vocab. Application" ${a.type==='Vocab. Application'?'selected':''}>Vocab. Application</option>
      <option value="Reading" ${a.type==='Reading'?'selected':''}>Reading</option>
      <option value="Writing" ${a.type==='Writing'?'selected':''}>Writing</option>
      <option value="Sentence Structure" ${a.type==='Sentence Structure'?'selected':''}>Sentence Structure</option>
    </select>

    <input type="text" class="inp-a-name" placeholder="Task Name (e.g. Journal Entry)" value="${a.name || ''}">

    <div class="row-delete" onclick="this.parentElement.remove()">‚úï</div>

    <textarea class="inp-a-notes" placeholder="Activity Notes..." style="grid-column: 1 / -1; height:100px;">${a.details || ''}</textarea>

    <div class="status-right" style="grid-column: 1 / -1; display:flex; gap:10px; align-items:center;">
      <select class="inp-a-link lesson-link-dropdown" style="max-width: 200px;">${lessonOpts}</select>
      <select class="inp-a-status" style="max-width: 220px;">
        <option value="Planned" ${a.status==='Planned'?'selected':''}>Planned</option>
        <option value="Completed" ${a.status==='Completed'?'selected':''}>Completed</option>
      </select>
    </div>
  `;

  document.getElementById('activity-container').appendChild(div);
  window.updateLessonLinkOptions();
};
    window.addVocabRow = function(v = {}) {
        const div = document.createElement('div');
        div.className = 'complex-row vocab-grid-inp';
        let lessonOpts = '<option value="">-- Link to Assignment --</option>';
        if(v.linkedLesson) lessonOpts += `<option value="${v.linkedLesson}" selected>${v.linkedLesson}</option>`;

        // Row 1: Word, Link, Delete (No Definitions, No Root)
        div.innerHTML = `
            <input type="text" class="inp-v-word" placeholder="Word" value="${v.word || ''}">
            <select class="inp-v-link lesson-link-dropdown">${lessonOpts}</select>
            <div class="row-delete" onclick="this.parentElement.remove()">‚úï</div>
        `;
        document.getElementById('vocab-container').appendChild(div);
        window.updateLessonLinkOptions();
    };

    // Updated to pull from both Lesson Names AND Activity Names
    window.updateLessonLinkOptions = function() {
        const lessonInputs = document.querySelectorAll('.inp-l-name');
        const activityInputs = document.querySelectorAll('.inp-a-name');
        
        const combinedItems = [];
        
        lessonInputs.forEach(inp => { 
            if(inp.value.trim()) combinedItems.push({ name: inp.value.trim(), type: '[Lesson]' }); 
        });
        
        activityInputs.forEach(inp => { 
            if(inp.value.trim()) combinedItems.push({ name: inp.value.trim(), type: '[Activity]' }); 
        });

        const selects = document.querySelectorAll('.lesson-link-dropdown');
        selects.forEach(sel => {
            const currentVal = sel.value;
            let html = '<option value="">Link</option>';
            
            combinedItems.forEach(item => {
                const displayName = `${item.type} ${item.name}`;
                const selected = displayName === currentVal ? 'selected' : '';
                html += `<option value="${displayName}" ${selected}>${displayName}</option>`;
            });

            if(currentVal && !combinedItems.find(i => `${i.type} ${i.name}` === currentVal)) {
                 // Keep existing value even if it's not in list currently (legacy support)
                 html += `<option value="${currentVal}" selected>${currentVal}</option>`;
            }
            sel.innerHTML = html;
        });
    };

    window.saveUnit = async function(e) {
        if(e) e.preventDefault();
        const id = document.getElementById('inp-id').value;
        
        let lessons = [];
        document.querySelectorAll('#lessons-container .complex-row').forEach(row => {
            if(row.querySelector('.inp-l-name').value.trim()) {
                lessons.push({
                    date: row.querySelector('.inp-l-date').value,
                    category: row.querySelector('.inp-l-cat').value,
                    status: row.querySelector('.inp-l-status').value, 
                    name: row.querySelector('.inp-l-name').value,
                    details: row.querySelector('.inp-l-notes').value,
                    isFlex: false 
                });
            }
        });

        let activities = [];
        document.querySelectorAll('#activity-container .complex-row').forEach(row => {
            if(row.querySelector('.inp-a-name').value.trim()) {
                activities.push({
                    date: row.querySelector('.inp-a-date').value,
                    type: row.querySelector('.inp-a-type').value,
                    status: row.querySelector('.inp-a-status').value, 
                    linkedLesson: row.querySelector('.inp-a-link').value,
                    name: row.querySelector('.inp-a-name').value,
                    details: row.querySelector('.inp-a-notes').value
                });
            }
        });

        let vocabulary = [];
        document.querySelectorAll('#vocab-container .complex-row').forEach(row => {
            if(row.querySelector('.inp-v-word').value.trim()) {
                vocabulary.push({
                    word: row.querySelector('.inp-v-word').value,
                    // removed root, definition & rootMean
                    linkedLesson: row.querySelector('.inp-v-link').value
                });
            }
        });

        
        lessons.sort((a, b) => { if(!a.date) return 1; if(!b.date) return -1; return new Date(a.date) - new Date(b.date); });
        activities.sort((a, b) => { if(!a.date) return 1; if(!b.date) return -1; return new Date(a.date) - new Date(b.date); });

        const data = {
            subject: document.getElementById('inp-subject').value,
            status: document.getElementById('inp-status').value,
            unit: document.getElementById('inp-unit').value,
            topic: document.getElementById('inp-topic').value,
            plannedStart: document.getElementById('inp-start').value,
            plannedEnd: document.getElementById('inp-end').value,
            strategy: document.getElementById('inp-strategy').value,
            lessons: lessons,
            activities: activities,
            vocabulary: vocabulary,
            updatedAt: Date.now()
        };

        if (id) await updateDoc(doc(db, COLLECTION, id), data);
        else await addDoc(collection(db, COLLECTION), data);
        window.closeModal();
    };

    window.toggleLessonStatus = async function(docId, lessonName) {
        const item = plans.find(p => p.id === docId);
        const lesson = item.lessons.find(l => l.name === lessonName);
        if(lesson) {
            lesson.status = (lesson.status === 'Completed' || lesson.status === 'Taught') ? 'Planned' : 'Completed';
            await updateDoc(doc(db, COLLECTION, docId), { lessons: item.lessons });
        }
    };

    window.toggleActivityStatus = async function(docId, actName) {
        const item = plans.find(p => p.id === docId);
        let activity = item.activities ? item.activities.find(a => a.name === actName) : null;
        if(!activity && item.lessons) {
             activity = item.lessons.find(l => l.isFlex && l.name === actName);
        }

        if(activity) {
            activity.status = (activity.status === 'Completed') ? 'Planned' : 'Completed';
            if(activity.isFlex) await updateDoc(doc(db, COLLECTION, docId), { lessons: item.lessons });
            else await updateDoc(doc(db, COLLECTION, docId), { activities: item.activities });
        }
    };

    window.deleteUnit = async function(id) { if(confirm("Delete this Unit?")) { await deleteDoc(doc(db, COLLECTION, id)); window.closeModal(); }};

    function formatDate(d) { 
        if(!d || d === 'undefined') return '--/--'; 
        if(typeof d === 'string' && d.includes('-')) {
            const p = d.split('-'); 
            if(p.length >= 3) return `${p[1]}/${p[2]}`;
        }
        return d; 
    }

    window.downloadPDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Remove Appendix Logic, handle in loop
        const units = plans.sort((a,b) => a.subject.localeCompare(b.subject));

        units.forEach((u, index) => {
            // FORCE NEW PAGE for every unit (except the very first page)
            if (index > 0) { doc.addPage(); }
            
            let yPos = 20;
            if (index === 0) {
                doc.setFontSize(18); doc.setFont("helvetica", "bold");
                doc.text("HOMESCHOOL RECORD", 105, 20, { align: "center" });
                doc.setFontSize(12); doc.setFont("helvetica", "normal");
                doc.text("Student: Gabriel Mendoza", 14, 32);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 38);
                doc.setLineWidth(0.5); doc.line(14, 42, 196, 42);
                yPos = 50;
            }

            // Unit Header Box
            doc.setFillColor(240, 240, 240); 
            doc.rect(14, yPos, 182, 10, 'F');
            doc.setFontSize(14); doc.setFont("helvetica", "bold");
            doc.setTextColor(0);
            doc.text(`${u.subject.toUpperCase()}: ${u.unit}`, 16, yPos + 7);
            yPos += 20;

            // Unit Details
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            if(u.topic) { doc.text(`Topic: ${u.topic}`, 14, yPos); yPos += 6; }
            if(u.strategy) { 
                const splitStrat = doc.splitTextToSize(`Strategy: ${u.strategy}`, 180);
                doc.text(splitStrat, 14, yPos);
                yPos += (splitStrat.length * 5) + 6;
            }

            // --- VOCABULARY SECTION (Inline) ---
            if(u.vocabulary && u.vocabulary.length > 0) {
                doc.setFontSize(11); doc.setFont("helvetica", "bold");
                doc.text("Vocabulary Focus", 14, yPos); 
                yPos += 5;
                
                doc.setFontSize(10); doc.setFont("helvetica", "normal");
                // Simple list: Word only
                const vocabList = u.vocabulary.map(v => v.word).join(', ');
                
                const splitVocab = doc.splitTextToSize(vocabList, 180);
                doc.text(splitVocab, 14, yPos);
                yPos += (splitVocab.length * 5) + 8;
            } else {
                 yPos += 5;
            }

            // --- Lessons ---
            const realLessons = u.lessons ? u.lessons.filter(l => !l.isFlex) : [];
            if(realLessons.length > 0) {
                doc.setFontSize(11); doc.setFont("helvetica", "bold");
                doc.text("Lesson Log", 14, yPos); yPos += 2;
                
                const lessonBody = realLessons.map(l => {
                    let content = l.name;
                    if(l.category && l.category !== 'General') content += ` (${l.category})`;
                    if(l.details) content += `\n${l.details}`;
                    const isComp = (l.status === 'Completed' || l.status === 'Taught');
                    return [formatDate(l.date), content, isComp ? 'COMPLETED' : 'PLANNED'];
                });

                doc.autoTable({
                    startY: yPos + 4,
                    head: [['Date', 'Lesson Details', 'Status']],
                    body: lessonBody,
                    theme: 'grid',
                    styles: { fontSize: 10, cellPadding: 3, valign: 'middle' },
                    headStyles: { fillColor: [44, 62, 80] },
                    // Status Width 30 fits COMPLETED
                    columnStyles: { 0: { cellWidth: 25 }, 2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' } }
                });
                yPos = doc.lastAutoTable.finalY + 14;
            }

            // --- Activities ---
            const legacyFlex = u.lessons ? u.lessons.filter(l => l.isFlex === true) : [];
            const legacyFlexAsActivities = legacyFlex.map(l => ({ ...l, type: 'General (Legacy)', status: 'Completed' }));
            const allActivities = [...(u.activities || []), ...legacyFlexAsActivities];

            if(allActivities.length > 0) {
                doc.setFontSize(11); doc.setFont("helvetica", "bold");
                doc.text("Activity Log", 14, yPos); yPos += 2;

                const actBody = allActivities.map(a => {
                    let content = a.name;
                    if(a.type && a.type !== 'General') content += ` (${a.type})`;
                    if(a.linkedLesson) content += `\nLink: ${a.linkedLesson}`;
                    if(a.details) content += `\n${a.details}`;
                    const isComp = (a.status === 'Completed');
                    return [formatDate(a.date), content, isComp ? 'COMPLETED' : 'PLANNED'];
                });

                doc.autoTable({
                    startY: yPos + 4,
                    head: [['Date', 'Activity Details', 'Status']],
                    body: actBody,
                    theme: 'grid',
                    styles: { fontSize: 10, cellPadding: 3, valign: 'middle' },
                    headStyles: { fillColor: [221, 107, 32] },
                    columnStyles: { 0: { cellWidth: 25 }, 2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' } }
                });
                yPos = doc.lastAutoTable.finalY + 14;
            }
        });

        doc.save(`Curriculum_Log.pdf`);
    };
</script>
</body>
</html>
